{% extends "site_base.html" %}

{% load humanize %}
{% load manoria_tags %}

{% block head_title %}{{ settlement.name }}{% endblock %}

{% block body_class %}settlement{% endblock %}

{% block body %}
    
    <div class="left-panel">
        <p><a href="{% url player_detail settlement.player.pk %}">{{ settlement.player }}</a></p>
        
        <h1>{{ settlement.kind|title }} of {{ settlement.name }}</h1>
        
        <p><b>Location</b>: {{ settlement.continent.name }} {{ settlement.x }}-{{ settlement.y }}</p>
        
        <h2>Resources</h2>
        
        {% if settlement.resource_counts %}
            <ul>
                {% for resource_count in settlement.resource_counts %}
                    <li>
                        {{ resource_count.kind.name }} = {{ resource_count.amount|intcomma }}
                        ({{ resource_count.rate|format_rate }}/hr;
                            {% if resource_count.limit %}limit {{ resource_count.limit|intcomma }}{% else %}no limit{% endif %})
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No resources in this settlement.</p>
        {% endif %}
        
        <h2>Terrain</h2>
        
        <p>This is really just listed here for debugging for now.</p>
        
        {% if settlement.terrain.all %}
            <ul>
                {% for terrain in settlement.terrain.all %}
                    <li>
                        <a href="{% url terrain_detail terrain.pk %}">{{ terrain.kind.name }}</a>
                        {{ terrain.x }}-{{ terrain.y }}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No terrain in this settlement (won't normally happen in gameplay)</p>
        {% endif %}
        
        
        <h2>Buildings</h2>
        
        {% if settlement.buildings %}
            <ul>
                {% for building in settlement.buildings %}
                    <li>
                        <a href="{% url building_detail building.pk %}">{{ building.kind.name }}</a>
                        {{ building.x }}-{{ building.y }}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No buildings in this settlement.</p>
        {% endif %}
        
        <h2>Build Queue</h2>
        
        {% if settlement.build_queue %}
            <ul>
                {% for building in settlement.build_queue %}
                    <li>
                        <a href="{% url building_detail building.pk %}">{{ building.kind.name }}</a>
                        {{ building.x }}-{{ building.y }}
                        <br />
                        {% if building.status == "queued" %}
                        starting in {{ building.construction_start|timeuntil }}
                        <br />
                        {% endif %}
                        finishing in {{ building.construction_end|timeuntil }}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No buildings in the build queue for this settlement.</p>
        {% endif %}
        
        <p><a href="{% url building_create settlement.pk %}">Create a building</a></p>
    </div>
    
    <div class="window">
        {% map settlement %}
    </div>
{% endblock %}

{% block extra_body %}
    <script>
        $(function() {
            $(".map").draggable();
            jQuery.event.add(window, "load", resizeFrame);
            jQuery.event.add(window, "resize", resizeFrame);
            
            function resizeFrame() 
            {
                var h = $(window).height();
                var w = $(window).width();
                $("div.window").css("height", h - 83);
                $("div.left-panel").css("height", h - 123);
                $("div.window").css("width", w - 342);
            }
        });
    </script>
{% endblock %}